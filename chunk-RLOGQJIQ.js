import{a as z}from"./chunk-VXLM4NOQ.js";import{a as m,b as R}from"./chunk-WOPIK6KX.js";import{$a as b,Ma as a,N as u,Na as i,Oa as _,P as h,Pb as F,Q as v,Sa as I,Va as E,Wa as w,Xb as V,_a as M,ab as S,ha as s,ib as n,jb as k,kb as l,oa as c,qa as y,qb as P,rb as f,sa as C,sb as T,tb as O,ub as D,ya as x}from"./chunk-DRVSLC3Q.js";import{f as g}from"./chunk-4IDNTCH7.js";var $=["popupTemplate"];function j(p,t){if(p&1){let e=I();a(0,"div",2)(1,"p",3),n(2),i(),a(3,"p",4)(4,"span",5),n(5,"\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0456\u044F:"),i(),n(6),f(7,"categoryLabel"),i(),a(8,"p",4)(9,"span",5),n(10,"\u0412\u0430\u0436\u043A\u0456\u0441\u0442\u044C:"),i(),n(11),i(),a(12,"p",4)(13,"span",5),n(14,"\u0414\u0430\u0442\u0430:"),i(),n(15),f(16,"date"),i(),a(17,"button",6),E("click",function(){let r=h(e).$implicit,d=w();return v(d.openIncident(r.id))}),n(18,"\u0414\u0435\u0442\u0430\u043B\u0456"),i()()}if(p&2){let e=t.$implicit;s(2),k(e.title),s(4),l(" ",T(7,4,e.category)),s(5),l(" ",e.severity),s(4),l(" ",O(16,6,e.createdAt,"medium"))}}var A=class p{constructor(t,e,o){this._filterService=t;this._incidentsService=e;this._categoryPipe=o}viewContainerRef=u(y);router=u(V);markerCluster;incidentsData=[];map;options={zoom:8,center:L.latLng(50.4501,30.5234),layers:[L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'})]};popupTemplate;ngAfterViewInit(){return g(this,null,function*(){this.map?this.map.invalidateSize():(L.markerClusterGroup||(yield import("./chunk-DP7YDRRQ.js")),this.initMap(),this.subscribeToFilterChanges())})}getIncidents(){this._incidentsService.loadData(this._filterService.currentFilters).subscribe(t=>{this.incidentsData=t,this.addMarkers()})}subscribeToFilterChanges(){this._filterService.filters$.subscribe(()=>{this.getIncidents()})}initMap(){this.map=L.map("map",{zoom:13,center:L.latLng(50.4501,30.5234),layers:[L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'})]})}addMarkers(){this.markerCluster&&this.map.removeLayer(this.markerCluster),this.markerCluster=L.markerClusterGroup(),this.incidentsData.forEach(t=>{let e=L.divIcon({html:`
        <div style="display: flex; flex-direction: column; align-items: center;">
          <img src="assets/leaflet/marker-icon.png" style="width: 25px; height: 41px;" />
          <span style="font-size: 12px; color: black; margin-top: 4px;">${this._categoryPipe.transform(t.category)}</span>
        </div>
      `,iconSize:[25,55],className:""}),o=this.viewContainerRef.createEmbeddedView(this.popupTemplate,{$implicit:t}),r=document.createElement("div");o.rootNodes.forEach(d=>r.appendChild(d)),L.marker([t.location.lat,t.location.lng],{alt:t.category,icon:e}).addTo(this.markerCluster).bindPopup(r)}),this.map.addLayer(this.markerCluster)}openIncident(t){this.router.navigate(["/incident",t])}ngOnDestroy(){this.map&&(this.map.off(),this.map.remove())}static \u0275fac=function(e){return new(e||p)(c(z),c(R),c(m))};static \u0275cmp=C({type:p,selectors:[["app-incidents-map"]],viewQuery:function(e,o){if(e&1&&M($,5),e&2){let r;b(r=S())&&(o.popupTemplate=r.first)}},features:[P([m])],decls:3,vars:0,consts:[["popupTemplate",""],["id","map"],[1,"incident-popup"],[1,"popup-title"],[1,"parameter"],[1,"parameter-name"],[3,"click"]],template:function(e,o){e&1&&(_(0,"div",1),x(1,j,19,9,"ng-template",null,0,D))},dependencies:[F,m],styles:["#map[_ngcontent-%COMP%]{width:550px;height:500px;border-radius:20px}.incident-popup[_ngcontent-%COMP%]   .popup-title[_ngcontent-%COMP%]{font-size:1rem;font-weight:600;text-align:center}.incident-popup[_ngcontent-%COMP%]   .parameter[_ngcontent-%COMP%]{margin:2px 0}.incident-popup[_ngcontent-%COMP%]   .parameter-name[_ngcontent-%COMP%]{font-weight:600}"]})};export{A as IncidentsMapComponent};
