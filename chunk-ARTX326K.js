import{a as V}from"./chunk-VXLM4NOQ.js";import{a as z,b as F}from"./chunk-WOPIK6KX.js";import{$a as M,Ma as o,N as l,Na as i,Oa as x,P as h,Pb as D,Q as g,Sa as I,Va as _,Wa as E,Xb as P,_a as w,ab as b,ha as s,ib as n,jb as S,kb as m,oa as d,qa as v,rb as u,sa as y,sb as k,tb as O,ub as T,ya as C}from"./chunk-DRVSLC3Q.js";import{f}from"./chunk-4IDNTCH7.js";var A=["popupTemplate"];function $(a,t){if(a&1){let e=I();o(0,"div",2)(1,"p",3),n(2),i(),o(3,"p",4)(4,"span",5),n(5,"\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0456\u044F:"),i(),n(6),u(7,"categoryLabel"),i(),o(8,"p",4)(9,"span",5),n(10,"\u0412\u0430\u0436\u043A\u0456\u0441\u0442\u044C:"),i(),n(11),i(),o(12,"p",4)(13,"span",5),n(14,"\u0414\u0430\u0442\u0430:"),i(),n(15),u(16,"date"),i(),o(17,"button",6),_("click",function(){let r=h(e).$implicit,c=E();return g(c.openIncident(r.id))}),n(18,"\u0414\u0435\u0442\u0430\u043B\u0456"),i()()}if(a&2){let e=t.$implicit;s(2),S(e.title),s(4),m(" ",k(7,4,e.category)),s(5),m(" ",e.severity),s(4),m(" ",O(16,6,e.createdAt,"medium"))}}var R=class a{constructor(t,e){this._filterService=t;this._incidentsService=e}viewContainerRef=l(v);router=l(P);markerCluster;incidentsData=[];map;options={zoom:8,center:L.latLng(50.4501,30.5234),layers:[L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'})]};popupTemplate;ngOnInit(){console.log(1)}ngAfterViewInit(){return f(this,null,function*(){this.map?this.map.invalidateSize():(L.markerClusterGroup||(yield import("./chunk-DP7YDRRQ.js")),this.initMap(),this.subscribeToFilterChanges())})}getIncidents(){this._incidentsService.loadData(this._filterService.currentFilters).subscribe(t=>{this.incidentsData=t,this.addMarkers()})}subscribeToFilterChanges(){this._filterService.filters$.subscribe(()=>{this.getIncidents()})}initMap(){this.map=L.map("map",{zoom:13,center:L.latLng(50.4501,30.5234),layers:[L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'})]})}addMarkers(){this.markerCluster&&this.map.removeLayer(this.markerCluster),this.markerCluster=L.markerClusterGroup(),this.incidentsData.forEach(t=>{let e=L.divIcon({html:`
        <div style="display: flex; flex-direction: column; align-items: center;">
          <img src="assets/leaflet/marker-icon.png" style="width: 25px; height: 41px;" />
          <span style="font-size: 12px; color: black; margin-top: 4px;">${t.category}</span>
        </div>
      `,iconSize:[25,55],className:""}),p=this.viewContainerRef.createEmbeddedView(this.popupTemplate,{$implicit:t}),r=document.createElement("div");p.rootNodes.forEach(c=>r.appendChild(c)),L.marker([t.location.lat,t.location.lng],{alt:t.category,icon:e}).addTo(this.markerCluster).bindPopup(r)}),this.map.addLayer(this.markerCluster)}openIncident(t){this.router.navigate(["/incident",t])}ngOnDestroy(){this.map&&(this.map.off(),this.map.remove())}static \u0275fac=function(e){return new(e||a)(d(V),d(F))};static \u0275cmp=y({type:a,selectors:[["app-incidents-map"]],viewQuery:function(e,p){if(e&1&&w(A,5),e&2){let r;M(r=b())&&(p.popupTemplate=r.first)}},decls:3,vars:0,consts:[["popupTemplate",""],["id","map"],[1,"incident-popup"],[1,"popup-title"],[1,"parameter"],[1,"parameter-name"],[3,"click"]],template:function(e,p){e&1&&(x(0,"div",1),C(1,$,19,9,"ng-template",null,0,T))},dependencies:[D,z],styles:["#map[_ngcontent-%COMP%]{width:550px;height:500px;border-radius:20px}.incident-popup[_ngcontent-%COMP%]   .popup-title[_ngcontent-%COMP%]{font-size:1rem;font-weight:600;text-align:center}.incident-popup[_ngcontent-%COMP%]   .parameter[_ngcontent-%COMP%]{margin:2px 0}.incident-popup[_ngcontent-%COMP%]   .parameter-name[_ngcontent-%COMP%]{font-weight:600}"]})};export{R as IncidentsMapComponent};
