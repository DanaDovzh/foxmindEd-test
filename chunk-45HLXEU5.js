import{a as V}from"./chunk-Z5EOS67G.js";import{a as z,b as D}from"./chunk-3EAYMFXH.js";import{$a as _,Da as C,Ra as o,S as l,Sa as i,Ta as x,U as f,Ub as O,V as g,Xa as y,_a as I,ac as P,db as E,eb as w,fb as M,ma as s,nb as n,ob as b,pb as c,ta as d,va as h,wb as u,xa as v,xb as S,yb as k,zb as T}from"./chunk-XBVD5SFW.js";var R=["popupTemplate"];function A(p,t){if(p&1){let e=y();o(0,"div",2)(1,"p",3),n(2),i(),o(3,"p",4)(4,"span",5),n(5,"\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0456\u044F:"),i(),n(6),u(7,"categoryLabel"),i(),o(8,"p",4)(9,"span",5),n(10,"\u0412\u0430\u0436\u043A\u0456\u0441\u0442\u044C:"),i(),n(11),i(),o(12,"p",4)(13,"span",5),n(14,"\u0414\u0430\u0442\u0430:"),i(),n(15),u(16,"date"),i(),o(17,"button",6),I("click",function(){let r=f(e).$implicit,m=_();return g(m.openIncident(r.id))}),n(18,"\u0414\u0435\u0442\u0430\u043B\u0456"),i()()}if(p&2){let e=t.$implicit;s(2),b(e.title),s(4),c(" ",S(7,4,e.category)),s(5),c(" ",e.severity),s(4),c(" ",k(16,6,e.createdAt,"medium"))}}var F=class p{constructor(t,e){this._filterService=t;this._incidentsService=e}viewContainerRef=l(h);router=l(P);markerCluster;incidentsData=[];map;options={zoom:8,center:L.latLng(50.4501,30.5234),layers:[L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'})]};popupTemplate;ngOnInit(){this.subscribeToFilterChanges()}ngAfterViewInit(){this.initMap(),setTimeout(()=>{this.map.invalidateSize()},0)}getIncidents(){this._incidentsService.loadData(this._filterService.currentFilters).subscribe(t=>{this.incidentsData=t,this.addMarkers()})}subscribeToFilterChanges(){this._filterService.filters$.subscribe(()=>{this.getIncidents()})}initMap(){this.map=L.map("map",{zoom:13,center:L.latLng(50.4501,30.5234),layers:[L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'})]})}addMarkers(){this.markerCluster&&this.map.removeLayer(this.markerCluster),this.markerCluster=L.markerClusterGroup(),this.incidentsData.forEach(t=>{let e=L.divIcon({html:`
        <div style="display: flex; flex-direction: column; align-items: center;">
          <img src="assets/leaflet/marker-icon.png" style="width: 25px; height: 41px;" />
          <span style="font-size: 12px; color: black; margin-top: 4px;">${t.category}</span>
        </div>
      `,iconSize:[25,55],className:""}),a=this.viewContainerRef.createEmbeddedView(this.popupTemplate,{$implicit:t}),r=document.createElement("div");a.rootNodes.forEach(m=>r.appendChild(m)),L.marker([t.location.lat,t.location.lng],{alt:t.category,icon:e}).addTo(this.markerCluster).bindPopup(r)}),this.map.addLayer(this.markerCluster)}openIncident(t){this.router.navigate(["/incident",t])}static \u0275fac=function(e){return new(e||p)(d(V),d(D))};static \u0275cmp=v({type:p,selectors:[["app-incidents-map"]],viewQuery:function(e,a){if(e&1&&E(R,5),e&2){let r;w(r=M())&&(a.popupTemplate=r.first)}},decls:3,vars:0,consts:[["popupTemplate",""],["id","map"],[1,"incident-popup"],[1,"popup-title"],[1,"parameter"],[1,"parameter-name"],[3,"click"]],template:function(e,a){e&1&&(x(0,"div",1),C(1,A,19,9,"ng-template",null,0,T))},dependencies:[O,z],styles:["#map[_ngcontent-%COMP%]{width:550px;height:500px;border-radius:20px}.incident-popup[_ngcontent-%COMP%]   .popup-title[_ngcontent-%COMP%]{font-size:1rem;font-weight:600;text-align:center}.incident-popup[_ngcontent-%COMP%]   .parameter[_ngcontent-%COMP%]{margin:2px 0}.incident-popup[_ngcontent-%COMP%]   .parameter-name[_ngcontent-%COMP%]{font-weight:600}"]})};export{F as IncidentsMapComponent};
